<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Connect Nearby Devices Part 1: Local Networking iOS</title>
		<meta name="description" content="Learn to build an iOS app that connects nearby devices over a local network.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Brendan Innis">
		<link rel="alternate" href="/feed/feed.json" type="application/json" title="Brendan Innis">
		
		<style>/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
* { box-sizing: border-box; }
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;

	--horizontal-padding: 3rem;
}
@media (max-width: 820px) {
	:root {
		--horizontal-padding: 1rem;
	}
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;
	--color-gray-95: #000308;

	--background-color: #FFFCF786;
	--background-image: url(/img/spiration-light.png);

	--theme-background-color: #00030813;

	--text-color: var(--color-gray-95);
	--text-color-link: #301014;
	--text-color-link-active: #5f2b48;
	--text-color-link-visited: #5E555A;

	--syntax-tab-size: 2;
}

:root[data-theme="dark"] {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #dad8d8;
	--color-gray-95: #FFFCF7;

	--theme-background-color: #FFFCF713;

	/* --text-color is assigned to --color-gray-_ above */
	--text-color-link: #b5bad0;
	--text-color-link-active: #FFDD93;
	--text-color-link-visited: #8594ad;

	--background-color: #06010a86;
	--background-image: url(/img/spiration-dark.png);
}

/* Global stylesheet */
* {
	box-sizing: border-box;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	min-height: 100vh;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	background-image: var(--background-image);
}
body {
	max-width: calc(80ch + var(--horizontal-padding) * 2);
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

a > svg:hover {
	fill: var(--text-color-link-active);
}

main {
	padding: 1rem var(--horizontal-padding);
}
main :first-child {
	margin-top: 0;
}

h1 {
	margin-top: 0.25em;
}

header {
	display: flex;
	border-bottom: 1px dashed var(--color-gray-90);
}
header:after {
	content: "";
	display: table;
	clear: both;
}

span.spacer {
	flex-grow: 1;
}

.links-nextprev {
	list-style: none;
	border-top: 1px dashed var(--color-gray-90);
	margin: 0 calc(-1 * var(--horizontal-padding));
	padding: 0;
}
.links-nextprev li {
	margin: 1em 0;
	padding: 0 var(--horizontal-padding);
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
}
pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
}
code {
	word-break: break-all;
}

img {
	display: block;
	margin: 0 auto;
	max-width: 100%;
	height: auto;
}

/* Header */
header {
	display: flex;
	gap: 1em .5em;
	flex-wrap: wrap;
	align-items: center;
	padding: 1em var(--horizontal-padding);
}
a[href]:visited.home-link,
.nav-item a[href]:visited {
	color: var(--text-color-link);
}
a[href]:hover.home-link,
a[href]:active.home-link,
.nav-item a[href]:hover,
.nav-item a[href]:active {
	color: var(--text-color-link-active);
}
.home-link {
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
	margin-right: 2em;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
	margin-right: 1em;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

#theme {
	margin: -1em 0 -1em 0;
	background: none;
	border: none;
	border-radius: 50%;
	cursor: pointer;
	font-size: 1em; /* 16px /16 */
	padding: 0;
	display: flex;
  flex-direction: row;
  align-items: center;
}
#theme:hover {
	background: var(--theme-background-color);
}
#theme > svg {
	height: 2em;
	width: 2em;
}

/* Posts list */
.postlist {
	list-style: none;
	padding: 0;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	margin-bottom: 1em;
}
.postlist-date {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

#subscribe-link > svg {
	vertical-align: bottom;
	margin-bottom: 0.125em;
}

/* About */
#sidebar-icon-links {
	margin-top: 1em;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	text-transform: capitalize;
	font-style: italic;
}
.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

/* Direct Links / Markdown Headers */
h2 {
	margin-top: 1.5em;
}

.header-anchor {
	text-decoration: none;
	font-style: normal;
	font-size: 1em;
	margin-left: .1em;
}
a[href].header-anchor,
a[href].header-anchor:visited {
	color: transparent;
}
a[href].header-anchor:focus,
a[href].header-anchor:hover {
	text-decoration: underline;
}
a[href].header-anchor:focus,
:hover > a[href].header-anchor {
	color: var(--text-color-link-active);
}

h2 + .header-anchor {
	font-size: 1.5em;
}</style>
		<!-- Google tag (gtag.js) -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-998XX4MGQY"></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());

			gtag('config', 'G-998XX4MGQY');
		</script>

	</head>
	<body>
		<a href="#skip" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">Brendan Innis</a>
			<nav>
				<h2 class="visually-hidden">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Posts</a></li>
					<li class="nav-item"><a href="/tags.html">Tags</a></li>
					<li class="nav-item"><a href="/about.html">About Me</a></li>
				</ul>
			</nav>
			<span class="spacer"></span>
			<button id="theme" aria-label="Toggle theme" class="theme-toggle"></button>
		</header>

		<main id="skip">
			
<link id="syntax-theme-css" rel="stylesheet" href="css/prism-one-dark.css" />

<ul class="post-metadata">
	<li><svg width="24" height="24" viewBox="0 0 24 24" fill="var(--text-color)" xmlns="http://www.w3.org/2000/svg"><path d="M9 2a1 1 0 0 1 1 1v1h4V3a1 1 0 1 1 2 0v1h3a2 2 0 0 1 2 2v13a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h3V3a1 1 0 0 1 1-1zM8 6H5v3h14V6h-3v1a1 1 0 1 1-2 0V6h-4v1a1 1 0 0 1-2 0V6zm11 5H5v8h14v-8z"/></svg></li>
	<li><time datetime="2019-11-09">09 November 2019</time></li>
	<li><svg width="24" height="24" viewBox="0 0 24 24" fill="var(--text-color)" xmlns="http://www.w3.org/2000/svg"><path d="M2 3a1 1 0 0 1 1-1h8a1 1 0 0 1 .707.293l10 10a1 1 0 0 1 0 1.414l-8 8a1 1 0 0 1-1.414 0l-10-10A1 1 0 0 1 2 11V3zm2 1v6.586l9 9L19.586 13l-9-9H4z" /><path d="M9 7.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z" /></svg></li>
	<li><a href="/tags/ios/" class="post-tag">iOS</a>, </li>
	<li><a href="/tags/swift/" class="post-tag">Swift</a>, </li>
	<li><a href="/tags/networking/" class="post-tag">Networking</a></li>
</ul>

<h1>Connect Nearby Devices Part 1: Local Networking iOS</h1>

<p>Want to create an app that connects to nearby devices running the same app and is able to share data without going over the internet? So did I, but I had a hard time finding a good source of information online to teach me how to do that. In this series I'm going to explain how to create an app that can connect many devices running iOS or Android and share data between them.</p>
<p>The first part of this seriers will teach you to build an iOS app that can connect to other devices over a Local Area Network. Further parts of this series will cover Android as well as using Bluetooth as an alternative strategy to connect nearby devices.</p>
<h2 id="example-local-networking-app" tabindex="-1">Example Local Networking App <a class="header-anchor" href="#example-local-networking-app">#</a></h2>
<p>I built an iOS app that can join a realtime messaging chat with any other devices on the same local network. The first person who joins the chat will become the host and other people running the app that join the chat will be connected to the host. Everyone will be assinged a random name after a character from the Belgariad. You can follow along with this tutorial and build you own app, or you can also download the repository of the finished app here: <a href="https://github.com/brendaninnis/LocalNetworkingApp">Finished Example</a>.</p>
<h2 id="connecting-devices-over-a-local-network" tabindex="-1">Connecting devices over a local network <a class="header-anchor" href="#connecting-devices-over-a-local-network">#</a></h2>
<p>There are 2 parts to building this app, discovery and connection.</p>
<p>Discovery means we need devices running the same app to be able to see each other so that they can connect. For discovery we can use <a href="https://developer.apple.com/bonjour/">Bonjour</a>, an open source technology which allows a device to publish and listen for services running on the same network. We can then get the ip address and port of the host device in order that we can connect.</p>
<p>For connection we can use TCP/IP sockets to connect our devices and pass messages back and forth. The library I chose to use for this is called <a href="https://github.com/robbiehanson/CocoaAsyncSocket">CocoaAsyncSocket</a>.</p>
<h2 id="cocoaasyncsocket" tabindex="-1">CocoaAsyncSocket <a class="header-anchor" href="#cocoaasyncsocket">#</a></h2>
<p>The first thing to do, following the intructions in the <a href="https://github.com/robbiehanson/CocoaAsyncSocket">Readme</a>, is to install CocoaAsyncSocket in your project. Use <a href="https://cocoapods.org/">CocoaPods</a> and add this line to your Podfile:</p>
<pre class="language-ruby" tabindex="0"><code class="language-ruby">use_frameworks<span class="token operator">!</span> <span class="token comment"># Add this if you are targeting iOS 8+ or using Swift</span>
pod <span class="token string-literal"><span class="token string">'CocoaAsyncSocket'</span></span></code></pre>
<p>The class we are going to be using from CocoaAsyncSocket is called GCDAsyncSocket. It is a thread-safe TCP/IP socket that runs entirely within it's own <a href="https://developer.apple.com/documentation/DISPATCH">GCD</a> queue and uses a delegate pattern to execute callbacks on the queue you supplied. Sockets are used to connect two devices over a network so that they can exchange messages. If any of this is sounding new or unfamiliar to you I highly recommend reading the <a href="https://github.com/robbiehanson/CocoaAsyncSocket/wiki">CoacoaAsyncPods wiki</a>.
The wiki does an excellent job introducing networking concepts and reading and writing using the <a href="https://github.com/robbiehanson/CocoaAsyncSocket/wiki/Intro_GCDAsyncSocket">GCDAsyncSocket</a> library.</p>
<h2 id="hosting" tabindex="-1">Hosting <a class="header-anchor" href="#hosting">#</a></h2>
<p>In order to maintain communication and a shared state between more than 2 devices, we will use a client-server model for this app. One device will act as a host, and every other device will act as a client of that host. Thus there will be a socket connection between each client and the host. The host must accept socket connections over the network.</p>
<p>We'll create a variable as a property of our view controller to hold our socket as well as a dispatch queue for the socket to do work in.</p>
<pre class="language-swift" tabindex="0"><code class="language-swift"><span class="token keyword">var</span> socket<span class="token punctuation">:</span> <span class="token class-name">GCDAsyncSocket</span><span class="token operator">?</span>
<span class="token keyword">let</span> socketQueue <span class="token operator">=</span> <span class="token class-name">DispatchQueue</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>label<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"HostSocketQueue"</span></span><span class="token punctuation">)</span></code></pre>
<p>Then, when we want to start hosting, we'll initialize a socket and start accepting connections.</p>
<pre class="language-swift" tabindex="0"><code class="language-swift"><span class="token comment">// Create the listen socket</span>
socket <span class="token operator">=</span> <span class="token class-name">GCDAsyncSocket</span><span class="token punctuation">(</span>delegate<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">,</span> delegateQueue<span class="token punctuation">:</span> socketQueue<span class="token punctuation">)</span>
<span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> socket<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>onPort<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token keyword">let</span> error <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"ERROR: </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">error</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span></code></pre>
<p>Passing <code>0</code> as the port argument allows the system to provide us a port. You can get the port number after the accept invocation.</p>
<pre class="language-swift" tabindex="0"><code class="language-swift"><span class="token keyword">let</span> port <span class="token operator">=</span> socket<span class="token operator">!</span><span class="token punctuation">.</span>localPort</code></pre>
<p>Now our host device has a socket that is accepting connections. We need our view controller to adopt the <code>GCDAsyncSocketDelegate</code> protocol to get a callback when new sockets are accepted. When a client device connects, we will get a reference to the client's socket. We'll create another property on our view controller to hold the connected client sockets.</p>
<pre class="language-swift" tabindex="0"><code class="language-swift"><span class="token keyword">var</span> connectedSockets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">GCDAsyncSocket</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></code></pre>
<p>Then we will implement a method of the <code>GCDAsyncSocketDelegate</code> protocol.</p>
<pre class="language-swift" tabindex="0"><code class="language-swift"><span class="token keyword">func</span> <span class="token function-definition function">socket</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> sock<span class="token punctuation">:</span> <span class="token class-name">GCDAsyncSocket</span><span class="token punctuation">,</span> didAcceptNewSocket newSocket<span class="token punctuation">:</span> <span class="token class-name">GCDAsyncSocket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    connectedSockets<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>newSocket<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>Now we have a reference to the socket on the connected client device. This is what we, the host device, will use to read data from and write to. When the client disconnects, we will want to remove the socket from our <code>connectedSockets</code> array, so we'll implement another delegate method.</p>
<pre class="language-swift" tabindex="0"><code class="language-swift"><span class="token keyword">func</span> <span class="token function-definition function">socketDidDisconnect</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> sock<span class="token punctuation">:</span> <span class="token class-name">GCDAsyncSocket</span><span class="token punctuation">,</span> withError err<span class="token punctuation">:</span> <span class="token class-name">Error</span><span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Socket did disconnect </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">err<span class="token operator">?</span><span class="token punctuation">.</span>localizedDescription <span class="token operator">??</span> <span class="token string-literal"><span class="token string">""</span></span></span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> index <span class="token operator">=</span> connectedSockets<span class="token punctuation">.</span><span class="token function">firstIndex</span><span class="token punctuation">(</span>of<span class="token punctuation">:</span> sock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        connectedSockets<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>at<span class="token punctuation">:</span> index<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>That covers the basic lifecycle of creating a socket to accept connections, and getting connected client sockets to read and write messages, but there is one more thing the host needs to do.</p>
<p>In order for clients to connect, they need to know the ip address and port number of the host device. We can publish and discover our service over the network using <a href="https://developer.apple.com/bonjour/">Bonjour</a>, also known as zero-configuration networking.</p>
<h2 id="netservice" tabindex="-1">NetService <a class="header-anchor" href="#netservice">#</a></h2>
<p>As the host device, we will be publishing a service over the network that client devices will be able to discover. We need to use the <a href="https://developer.apple.com/documentation/foundation/netservice">NetService</a> class to accomplish this. First, create a new view controller property to reference an instance of <code>NetService</code>.</p>
<pre class="language-swift" tabindex="0"><code class="language-swift"><span class="token keyword">var</span> netService<span class="token punctuation">:</span> <span class="token class-name">NetService</span><span class="token operator">?</span></code></pre>
<p>Once we have created a socket and are accepting connections, we'll publish our service.</p>
<pre class="language-swift" tabindex="0"><code class="language-swift"><span class="token comment">// Publish a NetService</span>
netService <span class="token operator">=</span> <span class="token class-name">NetService</span><span class="token punctuation">(</span>domain<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"local."</span></span><span class="token punctuation">,</span> type<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"_LocalNetworkingApp._tcp."</span></span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"LocalNetworkingApp"</span></span><span class="token punctuation">,</span> port<span class="token punctuation">:</span> <span class="token class-name">Int32</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span>
netService<span class="token operator">?</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> <span class="token keyword">self</span>
netService<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>When initializing our <code>NetService</code>, we use <code>&quot;local&quot;.</code> to limit registration to the local domain. The type of our service we will call <code>LocalNetworkingApp</code> and we will specify TCP as the protocol (this could be a value such as <code>&quot;_http._tcp&quot;</code>, for example, to specify an HTTP service). We also give it a name and provide the port that our socket is accepting connections on.</p>
<p>Our view controller will need to adopt the <code>NetServiceDelegate</code> protocol. As a host you will be interested in the following delegate methods:</p>
<pre class="language-swift" tabindex="0"><code class="language-swift"><span class="token keyword">func</span> <span class="token function-definition function">netServiceDidPublish</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> sender<span class="token punctuation">:</span> <span class="token class-name">NetService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Bonjour Service Published: domain(</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">sender<span class="token punctuation">.</span>domain</span><span class="token interpolation-punctuation punctuation">)</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> type(</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">sender<span class="token punctuation">.</span>type</span><span class="token interpolation-punctuation punctuation">)</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> name(</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">sender<span class="token punctuation">.</span>name</span><span class="token interpolation-punctuation punctuation">)</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> port(</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">sender<span class="token punctuation">.</span>port</span><span class="token interpolation-punctuation punctuation">)</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function-definition function">netService</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> sender<span class="token punctuation">:</span> <span class="token class-name">NetService</span><span class="token punctuation">,</span> didNotPublish errorDict<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">String</span> <span class="token punctuation">:</span> <span class="token class-name">NSNumber</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Failed to publish Bonjour Service domain(</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">sender<span class="token punctuation">.</span>domain</span><span class="token interpolation-punctuation punctuation">)</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> type(</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">sender<span class="token punctuation">.</span>type</span><span class="token interpolation-punctuation punctuation">)</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> name(</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">sender<span class="token punctuation">.</span>name</span><span class="token interpolation-punctuation punctuation">)</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">\n</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">errorDict</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>The call to <code>netService?.publish()</code> finally makes our service discoverable by the client devices.</p>
<h2 id="clients" tabindex="-1">Clients <a class="header-anchor" href="#clients">#</a></h2>
<p>Once one device running our app is acting as the host, the rest of the devices will act as clients. The first thing to do is to discover the service so we can connect to the address of the host. For this we can use the <code>NetServiceBrowser</code> class. As always, use a property on your view controller to hold your instance of <code>NetServiceBrowser</code>.</p>
<pre class="language-swift" tabindex="0"><code class="language-swift"><span class="token keyword">var</span> netServiceBrowser<span class="token punctuation">:</span> <span class="token class-name">NetServiceBrowser</span><span class="token operator">?</span></code></pre>
<p>Then when we are ready to discover a service we will initialize the browser and search for our service.</p>
<pre class="language-swift" tabindex="0"><code class="language-swift">netServiceBrowser <span class="token operator">=</span> <span class="token class-name">NetServiceBrowser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
netServiceBrowser<span class="token operator">?</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> <span class="token keyword">self</span>
netServiceBrowser<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">searchForServices</span><span class="token punctuation">(</span>ofType<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"_LocalNetworkingApp._tcp."</span></span><span class="token punctuation">,</span> inDomain<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"local."</span></span><span class="token punctuation">)</span></code></pre>
<p>Of course, we'll need our view controller to adopt the <code>NetServiceBrowserDelegate</code> protocol. When we find the service published by the host, we'll grab an instance of the host <code>NetService</code> and attempt to resolve it.</p>
<pre class="language-swift" tabindex="0"><code class="language-swift"><span class="token keyword">extension</span> <span class="token class-name">ViewController</span><span class="token punctuation">:</span> <span class="token class-name">NetServiceBrowserDelegate</span> <span class="token punctuation">{</span>
    <span class="token keyword">func</span> <span class="token function-definition function">netServiceBrowser</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> browser<span class="token punctuation">:</span> <span class="token class-name">NetServiceBrowser</span><span class="token punctuation">,</span> didNotSearch errorDict<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">String</span> <span class="token punctuation">:</span> <span class="token class-name">NSNumber</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"ERROR: </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">errorDict</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">func</span> <span class="token function-definition function">netServiceBrowser</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> browser<span class="token punctuation">:</span> <span class="token class-name">NetServiceBrowser</span><span class="token punctuation">,</span> didFind service<span class="token punctuation">:</span> <span class="token class-name">NetService</span><span class="token punctuation">,</span> moreComing<span class="token punctuation">:</span> <span class="token class-name">Bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> netService <span class="token operator">==</span> <span class="token nil constant">nil</span> <span class="token punctuation">{</span>
            netService <span class="token operator">=</span> service
            netService<span class="token operator">?</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> <span class="token keyword">self</span>
            netService<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>withTimeout<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">func</span> <span class="token function-definition function">netServiceBrowserDidStopSearch</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> browser<span class="token punctuation">:</span> <span class="token class-name">NetServiceBrowser</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"NetServiceBrowser did stop search"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>When the <code>NetService</code> resolves, we will get a callback through the methods of the <code>NetServiceDelegate</code> protocol. First let's create a variable to hold the server addresses that will be returned by the service.</p>
<pre class="language-swift" tabindex="0"><code class="language-swift"><span class="token keyword">var</span> serverAddresses<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Data</span><span class="token punctuation">]</span><span class="token operator">?</span></code></pre>
<p>Then implement the <code>NetServiceDelegate</code> methods.</p>
<pre class="language-swift" tabindex="0"><code class="language-swift"><span class="token keyword">func</span> <span class="token function-definition function">netService</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> sender<span class="token punctuation">:</span> <span class="token class-name">NetService</span><span class="token punctuation">,</span> didNotResolve errorDict<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">String</span> <span class="token punctuation">:</span> <span class="token class-name">NSNumber</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"NetService did not resolve: </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">errorDict</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function-definition function">netServiceDidResolveAddress</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> sender<span class="token punctuation">:</span> <span class="token class-name">NetService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> serverAddresses <span class="token operator">==</span> <span class="token nil constant">nil</span> <span class="token punctuation">{</span>
        serverAddresses <span class="token operator">=</span> sender<span class="token punctuation">.</span>addresses
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> socket <span class="token operator">==</span> <span class="token nil constant">nil</span> <span class="token punctuation">{</span>
        socket <span class="token operator">=</span> <span class="token class-name">GCDAsyncSocket</span><span class="token punctuation">(</span>delegate<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">,</span> delegateQueue<span class="token punctuation">:</span> socketQueue<span class="token punctuation">)</span>
        <span class="token function">connectToNextAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>We hold on to the addresses of the host we will connect to. We also created a socket which will connect to the host address. Let's look at the <code>connectToNextAddress()</code> method.</p>
<pre class="language-swift" tabindex="0"><code class="language-swift"><span class="token keyword">func</span> <span class="token function-definition function">connectToNextAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> done <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>done <span class="token operator">&amp;&amp;</span> serverAddresses<span class="token operator">?</span><span class="token punctuation">.</span>count <span class="token operator">??</span> <span class="token number">0</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> addr <span class="token operator">=</span> serverAddresses<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>at<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> socket<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>toAddress<span class="token punctuation">:</span> addr<span class="token punctuation">)</span>
                done <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token keyword">let</span> error <span class="token punctuation">{</span>
                <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"ERROR: </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">error</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token operator">!</span>done <span class="token punctuation">{</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Unable to connect to any resolved address"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Here we try to connect to the addresses resovled by the host service that we discovered. When the socket connects to the host, we will be notified via a delegate method of <code>GCDAsyncSocketDelegate</code>. We'll create a boolean view controller property to track wether we as the client are connected.</p>
<pre class="language-swift" tabindex="0"><code class="language-swift"><span class="token keyword">var</span> connected <span class="token operator">=</span> <span class="token boolean">false</span></code></pre>
<p>Then we'll update the value in our <code>GCDAsyncSocketDelegate</code> methods.</p>
<pre class="language-swift" tabindex="0"><code class="language-swift"><span class="token keyword">func</span> <span class="token function-definition function">socket</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> sock<span class="token punctuation">:</span> <span class="token class-name">GCDAsyncSocket</span><span class="token punctuation">,</span> didConnectToHost host<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> port<span class="token punctuation">:</span> <span class="token class-name">UInt16</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Socket did connect to host </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">host</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> on port </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">port</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span>
    connected <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>


<span class="token keyword">func</span> <span class="token function-definition function">socketDidDisconnect</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> sock<span class="token punctuation">:</span> <span class="token class-name">GCDAsyncSocket</span><span class="token punctuation">,</span> withError err<span class="token punctuation">:</span> <span class="token class-name">Error</span><span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// ...</span>

    connected <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span></code></pre>
<p>That's it! Now our client devices can discover and connect to the host device. Our app has the ability to connect with other instances of itself running on the same network.</p>
<p>Of course the whole point of this is so that we can pass messages between them, so let's talk about reading and writing a bit.</p>
<h2 id="sending-messages" tabindex="-1">Sending Messages <a class="header-anchor" href="#sending-messages">#</a></h2>
<p>As long as our devices are connected, we want to be constantly reading a stream of data coming over the network. In order to know when a message begins and ends we will use a terminator. There are other ways to do this, such as reading certain lenghts of data at a time, but for simplicity's sake, we'll say that a message ends with the string <code>'\r\n'</code>. Fortunately, <code>GCDAsyncSocket</code> provides this as <code>Data</code> for us using the <code>GCDAsyncSocket.crlfData()</code> static method.</p>
<p>When a host accepts a new client, we want to start reading from the socket immediately, until we reach our terminator.</p>
<pre class="language-swift" tabindex="0"><code class="language-swift"><span class="token keyword">func</span> <span class="token function-definition function">socket</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> sock<span class="token punctuation">:</span> <span class="token class-name">GCDAsyncSocket</span><span class="token punctuation">,</span> didAcceptNewSocket newSocket<span class="token punctuation">:</span> <span class="token class-name">GCDAsyncSocket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// ...</span>

    <span class="token comment">// Wait for a message</span>
    newSocket<span class="token punctuation">.</span><span class="token function">readData</span><span class="token punctuation">(</span>to<span class="token punctuation">:</span> <span class="token class-name">GCDAsyncSocket</span><span class="token punctuation">.</span><span class="token function">crlfData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> withTimeout<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> tag<span class="token punctuation">:</span> <span class="token class-name">ViewController</span><span class="token punctuation">.</span><span class="token constant">MESSAGE_TAG</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>When a client connects to the host, we also want to start reading immediately from the socket.</p>
<pre class="language-swift" tabindex="0"><code class="language-swift"><span class="token keyword">func</span> <span class="token function-definition function">socket</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> sock<span class="token punctuation">:</span> <span class="token class-name">GCDAsyncSocket</span><span class="token punctuation">,</span> didConnectToHost host<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> port<span class="token punctuation">:</span> <span class="token class-name">UInt16</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// ...</span>

    <span class="token comment">// Connected to host, wait for a name</span>
    socket<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">readData</span><span class="token punctuation">(</span>to<span class="token punctuation">:</span> <span class="token class-name">GCDAsyncSocket</span><span class="token punctuation">.</span><span class="token function">crlfData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> withTimeout<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> tag<span class="token punctuation">:</span> <span class="token class-name">ViewController</span><span class="token punctuation">.</span><span class="token constant">NAME_TAG</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>The tag argument is an integer that is used to distinguish types of messages. That means the only data that will be read by this invocation is data sent using the same tag. In my case, the messaging app will assign a name to the client when they connect, so as the client the first message we want to read is a name.</p>
<p>We can send any <code>Data</code> over the network, but if we want to send a string, it's as simple as encoding the string and sending it over the socket. Of course we must end our message with the terminator so we know when to stop reading, so we'll append the terminator data to our message. In the client's case that will look like this:</p>
<pre class="language-swift" tabindex="0"><code class="language-swift"><span class="token keyword">guard</span> <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"Hello, world!"</span></span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>using<span class="token punctuation">:</span> <span class="token punctuation">.</span>utf8<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"ERROR: Couldn't encode string"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span>
data<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">GCDAsyncSocket</span><span class="token punctuation">.</span><span class="token function">crlfData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
socket<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> withTimeout<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> tag<span class="token punctuation">:</span> <span class="token class-name">ViewController</span><span class="token punctuation">.</span><span class="token constant">MESSAGE_TAG</span><span class="token punctuation">)</span></code></pre>
<p>For the host we may want to send a message to an individual client by writing to just their socket, or we may want to send a message to all the connected clients.</p>
<pre class="language-swift" tabindex="0"><code class="language-swift"><span class="token keyword">for</span> client <span class="token keyword">in</span> connectedSockets <span class="token punctuation">{</span>
    client<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> withTimeout<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> tag<span class="token punctuation">:</span> <span class="token class-name">ViewController</span><span class="token punctuation">.</span><span class="token constant">MESSAGE_TAG</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>Wether we are the host or a client, we will read data using the <code>GCDAsyncSocketDelegate</code> method.</p>
<pre class="language-swift" tabindex="0"><code class="language-swift"><span class="token keyword">func</span> <span class="token function-definition function">socket</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> sock<span class="token punctuation">:</span> <span class="token class-name">GCDAsyncSocket</span><span class="token punctuation">,</span> didRead data<span class="token punctuation">:</span> <span class="token class-name">Data</span><span class="token punctuation">,</span> withTag tag<span class="token punctuation">:</span> <span class="token class-name">Int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// We may want to read messages differently depending on the tag</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Socket did read data with tag </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">tag</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token comment">// If our data is a string we can decode it</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> data<span class="token punctuation">,</span> encoding<span class="token punctuation">:</span> <span class="token punctuation">.</span>utf8<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Finally we should continue to read data from the socket</span>
    sock<span class="token punctuation">.</span><span class="token function">readData</span><span class="token punctuation">(</span>to<span class="token punctuation">:</span> <span class="token class-name">GCDAsyncSocket</span><span class="token punctuation">.</span><span class="token function">crlfData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> withTimeout<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> tag<span class="token punctuation">:</span> <span class="token class-name">ViewController</span><span class="token punctuation">.</span><span class="token constant">MESSAGE_TAG</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>Of course this <code>Data</code> could contain JSON strings, images or anything else you want to send.</p>
<h2 id="finishing-up" tabindex="-1">Finishing Up <a class="header-anchor" href="#finishing-up">#</a></h2>
<p>When we want to end the connection from the host or stop hosting we should do some cleanup.</p>
<pre class="language-swift" tabindex="0"><code class="language-swift"><span class="token keyword">if</span> host <span class="token punctuation">{</span>
    <span class="token comment">// Stop listening</span>
    socket<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    netService<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    netService <span class="token operator">=</span> <span class="token nil constant">nil</span>

    <span class="token comment">// Remove the clients</span>
    <span class="token keyword">for</span> socket <span class="token keyword">in</span> connectedSockets <span class="token punctuation">{</span>
        socket<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    socket <span class="token operator">=</span> <span class="token nil constant">nil</span>

<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    netServiceBrowser<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    socket<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    socket <span class="token operator">=</span> <span class="token nil constant">nil</span>
    netService <span class="token operator">=</span> <span class="token nil constant">nil</span>
    serverAddresses <span class="token operator">=</span> <span class="token nil constant">nil</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="done" tabindex="-1">Done <a class="header-anchor" href="#done">#</a></h2>
<p>There are a few more details to pay attention to, but the above should cover the essentials of how to connect multiple devices running the same app over the local network and send messages back and forth. For a complete example of an app doing this, you can see my example <a href="https://github.com/brendaninnis/LocalNetworkingApp">messaging app</a>.</p>
<p>Part 2 of this tutorial series shows how to build an Android app that can connect to this one, which can be found <a href="http://brendaninnis.ca/connect-nearby-devices-part-2.html">here</a></p>
<p>In future parts of this series I will explain how to accomplish the same thing using Bluetooth communication. If there's anything I didn't explain or anything else you want to know, I'd love it if you left a comment.</p>

<ul class="links-nextprev"><li>Previous: <a href="/build-a-jekyll-site.html">Build a static site with Jekyll</a></li><li>Next: <a href="/connect-nearby-devices-part-2.html">Connect Nearby Devices Part 2: Local Networking Android</a></li>
</ul>

		</main>

		<footer></footer>

		<!-- This page `/connect-nearby-devices-part-1.html` was built on 2024-08-31T04:23:36.295Z -->

		<!-- Theme toggle -->
		<script defer>
			// Theme toggle icons
			const sun = "<svg enable-background=\"new 0 0 512 512\" height=\"512px\" id=\"Layer_1\" version=\"1.1\" viewBox=\"0 0 512 512\" width=\"512px\" xml:space=\"preserve\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\"><g><g><path d=\"M256,144c-61.75,0-112,50.25-112,112s50.25,112,112,112s112-50.25,112-112S317.75,144,256,144z M256,336    c-44.188,0-80-35.812-80-80c0-44.188,35.812-80,80-80c44.188,0,80,35.812,80,80C336,300.188,300.188,336,256,336z M256,112    c8.833,0,16-7.167,16-16V64c0-8.833-7.167-16-16-16s-16,7.167-16,16v32C240,104.833,247.167,112,256,112z M256,400    c-8.833,0-16,7.167-16,16v32c0,8.833,7.167,16,16,16s16-7.167,16-16v-32C272,407.167,264.833,400,256,400z M380.438,154.167    l22.625-22.625c6.25-6.25,6.25-16.375,0-22.625s-16.375-6.25-22.625,0l-22.625,22.625c-6.25,6.25-6.25,16.375,0,22.625    S374.188,160.417,380.438,154.167z M131.562,357.834l-22.625,22.625c-6.25,6.249-6.25,16.374,0,22.624s16.375,6.25,22.625,0    l22.625-22.624c6.25-6.271,6.25-16.376,0-22.625C147.938,351.583,137.812,351.562,131.562,357.834z M112,256    c0-8.833-7.167-16-16-16H64c-8.833,0-16,7.167-16,16s7.167,16,16,16h32C104.833,272,112,264.833,112,256z M448,240h-32    c-8.833,0-16,7.167-16,16s7.167,16,16,16h32c8.833,0,16-7.167,16-16S456.833,240,448,240z M131.541,154.167    c6.251,6.25,16.376,6.25,22.625,0c6.251-6.25,6.251-16.375,0-22.625l-22.625-22.625c-6.25-6.25-16.374-6.25-22.625,0    c-6.25,6.25-6.25,16.375,0,22.625L131.541,154.167z M380.459,357.812c-6.271-6.25-16.376-6.25-22.625,0    c-6.251,6.25-6.271,16.375,0,22.625l22.625,22.625c6.249,6.25,16.374,6.25,22.624,0s6.25-16.375,0-22.625L380.459,357.812z\" fill=\"var(--text-color)\"/></g></g></svg>";
			const moon = "<svg enable-background=\"new 0 0 512 512\" height=\"512px\" id=\"Layer_1\" version=\"1.1\" viewBox=\"0 0 512 512\" width=\"512px\" xml:space=\"preserve\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\"><path d=\"M349.852,343.15c-49.875,49.916-131.083,49.916-181,0c-49.916-49.918-49.916-131.125,0-181.021  c13.209-13.187,29.312-23.25,47.832-29.812c5.834-2.042,12.293-0.562,16.625,3.792c4.376,4.375,5.855,10.833,3.793,16.625  c-12.542,35.375-4,73.666,22.25,99.917c26.209,26.228,64.5,34.75,99.916,22.25c5.792-2.062,12.271-0.582,16.625,3.793  c4.376,4.332,5.834,10.812,3.771,16.625C373.143,313.838,363.06,329.941,349.852,343.15z M191.477,184.754  c-37.438,37.438-37.438,98.354,0,135.771c40,40.021,108.125,36.416,143-8.168c-35.959,2.25-71.375-10.729-97.75-37.084  c-26.375-26.354-39.333-61.771-37.084-97.729C196.769,179.796,194.039,182.192,191.477,184.754z\" fill=\"var(--text-color)\"/></svg>";

			// Check for default theme
			if (!("theme" in localStorage)) {
				localStorage.theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
			}

			// Apply theme
			function applyTheme() {
				document.documentElement.setAttribute("data-theme", localStorage.theme);

				let syntaxThemeCSS = document.getElementById("syntax-theme-css");

				if (localStorage.theme === "dark") {
					document.getElementById("theme").innerHTML = moon;
					if (syntaxThemeCSS !== null) {
						syntaxThemeCSS.href = "/css/prism-one-dark.css";
					}
				} else {
					document.getElementById("theme").innerHTML = sun;
					if (syntaxThemeCSS !== null) {
						syntaxThemeCSS.href = "/css/prism-one-light.css";
					}
				}
			}
			applyTheme();

			// Toggle theme
			document.getElementById("theme").addEventListener("click", function () {
				if (localStorage.theme === "dark") {
					localStorage.theme = "light";
				} else {
					localStorage.theme = "dark";
				}
				applyTheme();
			});
		</script>
	</body>
</html>
