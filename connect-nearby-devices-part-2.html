<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Connect Nearby Devices Part 2: Local Networking Android</title>
		<meta name="description" content="Learn to build an Android app that connects nearby devices over a local network.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Brendan Innis">
		<link rel="alternate" href="/feed/feed.json" type="application/json" title="Brendan Innis">
		
		<style>/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
/**
 * One Light theme for prism.js
 * Based on Atom's One Light theme: https://github.com/atom/atom/tree/master/packages/one-light-syntax
 */

/**
 * One Light colours (accurate as of commit eb064bf on 19 Feb 2021)
 * From colors.less
 * --mono-1: hsl(230, 8%, 24%);
 * --mono-2: hsl(230, 6%, 44%);
 * --mono-3: hsl(230, 4%, 64%)
 * --hue-1: hsl(198, 99%, 37%);
 * --hue-2: hsl(221, 87%, 60%);
 * --hue-3: hsl(301, 63%, 40%);
 * --hue-4: hsl(119, 34%, 47%);
 * --hue-5: hsl(5, 74%, 59%);
 * --hue-5-2: hsl(344, 84%, 43%);
 * --hue-6: hsl(35, 99%, 36%);
 * --hue-6-2: hsl(35, 99%, 40%);
 * --syntax-fg: hsl(230, 8%, 24%);
 * --syntax-bg: hsl(230, 1%, 98%);
 * --syntax-gutter: hsl(230, 1%, 62%);
 * --syntax-guide: hsla(230, 8%, 24%, 0.2);
 * --syntax-accent: hsl(230, 100%, 66%);
 * From syntax-variables.less
 * --syntax-selection-color: hsl(230, 1%, 90%);
 * --syntax-gutter-background-color-selected: hsl(230, 1%, 90%);
 * --syntax-cursor-line: hsla(230, 8%, 24%, 0.05);
 */

code[class*="language-"],
pre[class*="language-"] {
	background: hsl(230, 1%, 98%);
	color: hsl(230, 8%, 24%);
	font-family: "Fira Code", "Fira Mono", Menlo, Consolas, "DejaVu Sans Mono", monospace;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	line-height: 1.5;
	-moz-tab-size: 2;
	-o-tab-size: 2;
	tab-size: 2;
	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

/* Selection */
code[class*="language-"]::-moz-selection,
code[class*="language-"] *::-moz-selection,
pre[class*="language-"] *::-moz-selection {
	background: hsl(230, 1%, 90%);
	color: inherit;
}

code[class*="language-"]::selection,
code[class*="language-"] *::selection,
pre[class*="language-"] *::selection {
	background: hsl(230, 1%, 90%);
	color: inherit;
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: 0.5em 0;
	overflow: auto;
	border-radius: 0.3em;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: 0.2em 0.3em;
	border-radius: 0.3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.cdata {
	color: hsl(230, 4%, 64%);
}

.token.doctype,
.token.punctuation,
.token.entity {
	color: hsl(230, 8%, 24%);
}

.token.attr-name,
.token.class-name,
.token.boolean,
.token.constant,
.token.number,
.token.atrule {
	color: hsl(35, 99%, 36%);
}

.token.keyword {
	color: hsl(301, 63%, 40%);
}

.token.property,
.token.tag,
.token.symbol,
.token.deleted,
.token.important {
	color: hsl(5, 74%, 59%);
}

.token.selector,
.token.string,
.token.char,
.token.builtin,
.token.inserted,
.token.regex,
.token.attr-value,
.token.attr-value > .token.punctuation {
	color: hsl(119, 34%, 47%);
}

.token.variable,
.token.operator,
.token.function {
	color: hsl(221, 87%, 60%);
}

.token.url {
	color: hsl(198, 99%, 37%);
}

/* HTML overrides */
.token.attr-value > .token.punctuation.attr-equals,
.token.special-attr > .token.attr-value > .token.value.css {
	color: hsl(230, 8%, 24%);
}

/* CSS overrides */
.language-css .token.selector {
	color: hsl(5, 74%, 59%);
}

.language-css .token.property {
	color: hsl(230, 8%, 24%);
}

.language-css .token.function,
.language-css .token.url > .token.function {
	color: hsl(198, 99%, 37%);
}

.language-css .token.url > .token.string.url {
	color: hsl(119, 34%, 47%);
}

.language-css .token.important,
.language-css .token.atrule .token.rule {
	color: hsl(301, 63%, 40%);
}

/* JS overrides */
.language-javascript .token.operator {
	color: hsl(301, 63%, 40%);
}

.language-javascript .token.template-string > .token.interpolation > .token.interpolation-punctuation.punctuation {
	color: hsl(344, 84%, 43%);
}

/* JSON overrides */
.language-json .token.operator {
	color: hsl(230, 8%, 24%);
}

.language-json .token.null.keyword {
	color: hsl(35, 99%, 36%);
}

/* MD overrides */
.language-markdown .token.url,
.language-markdown .token.url > .token.operator,
.language-markdown .token.url-reference.url > .token.string {
	color: hsl(230, 8%, 24%);
}

.language-markdown .token.url > .token.content {
	color: hsl(221, 87%, 60%);
}

.language-markdown .token.url > .token.url,
.language-markdown .token.url-reference.url {
	color: hsl(198, 99%, 37%);
}

.language-markdown .token.blockquote.punctuation,
.language-markdown .token.hr.punctuation {
	color: hsl(230, 4%, 64%);
	font-style: italic;
}

.language-markdown .token.code-snippet {
	color: hsl(119, 34%, 47%);
}

.language-markdown .token.bold .token.content {
	color: hsl(35, 99%, 36%);
}

.language-markdown .token.italic .token.content {
	color: hsl(301, 63%, 40%);
}

.language-markdown .token.strike .token.content,
.language-markdown .token.strike .token.punctuation,
.language-markdown .token.list.punctuation,
.language-markdown .token.title.important > .token.punctuation {
	color: hsl(5, 74%, 59%);
}

/* General */
.token.bold {
	font-weight: bold;
}

.token.comment,
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}

.token.namespace {
	opacity: 0.8;
}

/* Plugin overrides */
/* Selectors should have higher specificity than those in the plugins' default stylesheets */

/* Show Invisibles plugin overrides */
.token.token.tab:not(:empty):before,
.token.token.cr:before,
.token.token.lf:before,
.token.token.space:before {
	color: hsla(230, 8%, 24%, 0.2);
}

/* Toolbar plugin overrides */
/* Space out all buttons and move them away from the right edge of the code block */
div.code-toolbar > .toolbar.toolbar > .toolbar-item {
	margin-right: 0.4em;
}

/* Styling the buttons */
div.code-toolbar > .toolbar.toolbar > .toolbar-item > button,
div.code-toolbar > .toolbar.toolbar > .toolbar-item > a,
div.code-toolbar > .toolbar.toolbar > .toolbar-item > span {
	background: hsl(230, 1%, 90%);
	color: hsl(230, 6%, 44%);
	padding: 0.1em 0.4em;
	border-radius: 0.3em;
}

div.code-toolbar > .toolbar.toolbar > .toolbar-item > button:hover,
div.code-toolbar > .toolbar.toolbar > .toolbar-item > button:focus,
div.code-toolbar > .toolbar.toolbar > .toolbar-item > a:hover,
div.code-toolbar > .toolbar.toolbar > .toolbar-item > a:focus,
div.code-toolbar > .toolbar.toolbar > .toolbar-item > span:hover,
div.code-toolbar > .toolbar.toolbar > .toolbar-item > span:focus {
	background: hsl(230, 1%, 78%); /* custom: darken(--syntax-bg, 20%) */
	color: hsl(230, 8%, 24%);
}

/* Line Highlight plugin overrides */
/* The highlighted line itself */
.line-highlight.line-highlight {
	background: hsla(230, 8%, 24%, 0.05);
}

/* Default line numbers in Line Highlight plugin */
.line-highlight.line-highlight:before,
.line-highlight.line-highlight[data-end]:after {
	background: hsl(230, 1%, 90%);
	color: hsl(230, 8%, 24%);
	padding: 0.1em 0.6em;
	border-radius: 0.3em;
	box-shadow: 0 2px 0 0 rgba(0, 0, 0, 0.2); /* same as Toolbar plugin default */
}

/* Hovering over a linkable line number (in the gutter area) */
/* Requires Line Numbers plugin as well */
pre[id].linkable-line-numbers.linkable-line-numbers span.line-numbers-rows > span:hover:before {
	background-color: hsla(230, 8%, 24%, 0.05);
}

/* Line Numbers and Command Line plugins overrides */
/* Line separating gutter from coding area */
.line-numbers.line-numbers .line-numbers-rows,
.command-line .command-line-prompt {
	border-right-color: hsla(230, 8%, 24%, 0.2);
}

/* Stuff in the gutter */
.line-numbers .line-numbers-rows > span:before,
.command-line .command-line-prompt > span:before {
	color: hsl(230, 1%, 62%);
}

/* Match Braces plugin overrides */
/* Note: Outline colour is inherited from the braces */
.rainbow-braces .token.token.punctuation.brace-level-1,
.rainbow-braces .token.token.punctuation.brace-level-5,
.rainbow-braces .token.token.punctuation.brace-level-9 {
	color: hsl(5, 74%, 59%);
}

.rainbow-braces .token.token.punctuation.brace-level-2,
.rainbow-braces .token.token.punctuation.brace-level-6,
.rainbow-braces .token.token.punctuation.brace-level-10 {
	color: hsl(119, 34%, 47%);
}

.rainbow-braces .token.token.punctuation.brace-level-3,
.rainbow-braces .token.token.punctuation.brace-level-7,
.rainbow-braces .token.token.punctuation.brace-level-11 {
	color: hsl(221, 87%, 60%);
}

.rainbow-braces .token.token.punctuation.brace-level-4,
.rainbow-braces .token.token.punctuation.brace-level-8,
.rainbow-braces .token.token.punctuation.brace-level-12 {
	color: hsl(301, 63%, 40%);
}

/* Diff Highlight plugin overrides */
/* Taken from https://github.com/atom/github/blob/master/styles/variables.less */
pre.diff-highlight > code .token.token.deleted:not(.prefix),
pre > code.diff-highlight .token.token.deleted:not(.prefix) {
	background-color: hsla(353, 100%, 66%, 0.15);
}

pre.diff-highlight > code .token.token.deleted:not(.prefix)::-moz-selection,
pre.diff-highlight > code .token.token.deleted:not(.prefix) *::-moz-selection,
pre > code.diff-highlight .token.token.deleted:not(.prefix)::-moz-selection,
pre > code.diff-highlight .token.token.deleted:not(.prefix) *::-moz-selection {
	background-color: hsla(353, 95%, 66%, 0.25);
}

pre.diff-highlight > code .token.token.deleted:not(.prefix)::selection,
pre.diff-highlight > code .token.token.deleted:not(.prefix) *::selection,
pre > code.diff-highlight .token.token.deleted:not(.prefix)::selection,
pre > code.diff-highlight .token.token.deleted:not(.prefix) *::selection {
	background-color: hsla(353, 95%, 66%, 0.25);
}

pre.diff-highlight > code .token.token.inserted:not(.prefix),
pre > code.diff-highlight .token.token.inserted:not(.prefix) {
	background-color: hsla(137, 100%, 55%, 0.15);
}

pre.diff-highlight > code .token.token.inserted:not(.prefix)::-moz-selection,
pre.diff-highlight > code .token.token.inserted:not(.prefix) *::-moz-selection,
pre > code.diff-highlight .token.token.inserted:not(.prefix)::-moz-selection,
pre > code.diff-highlight .token.token.inserted:not(.prefix) *::-moz-selection {
	background-color: hsla(135, 73%, 55%, 0.25);
}

pre.diff-highlight > code .token.token.inserted:not(.prefix)::selection,
pre.diff-highlight > code .token.token.inserted:not(.prefix) *::selection,
pre > code.diff-highlight .token.token.inserted:not(.prefix)::selection,
pre > code.diff-highlight .token.token.inserted:not(.prefix) *::selection {
	background-color: hsla(135, 73%, 55%, 0.25);
}

/* Previewers plugin overrides */
/* Based on https://github.com/atom-community/atom-ide-datatip/blob/master/styles/atom-ide-datatips.less and https://github.com/atom/atom/blob/master/packages/one-light-ui */
/* Border around popup */
.prism-previewer.prism-previewer:before,
.prism-previewer-gradient.prism-previewer-gradient div {
	border-color: hsl(0, 0, 95%);
}

/* Angle and time should remain as circles and are hence not included */
.prism-previewer-color.prism-previewer-color:before,
.prism-previewer-gradient.prism-previewer-gradient div,
.prism-previewer-easing.prism-previewer-easing:before {
	border-radius: 0.3em;
}

/* Triangles pointing to the code */
.prism-previewer.prism-previewer:after {
	border-top-color: hsl(0, 0, 95%);
}

.prism-previewer-flipped.prism-previewer-flipped.after {
	border-bottom-color: hsl(0, 0, 95%);
}

/* Background colour within the popup */
.prism-previewer-angle.prism-previewer-angle:before,
.prism-previewer-time.prism-previewer-time:before,
.prism-previewer-easing.prism-previewer-easing {
	background: hsl(0, 0%, 100%);
}

/* For angle, this is the positive area (eg. 90deg will display one quadrant in this colour) */
/* For time, this is the alternate colour */
.prism-previewer-angle.prism-previewer-angle circle,
.prism-previewer-time.prism-previewer-time circle {
	stroke: hsl(230, 8%, 24%);
	stroke-opacity: 1;
}

/* Stroke colours of the handle, direction point, and vector itself */
.prism-previewer-easing.prism-previewer-easing circle,
.prism-previewer-easing.prism-previewer-easing path,
.prism-previewer-easing.prism-previewer-easing line {
	stroke: hsl(230, 8%, 24%);
}

/* Fill colour of the handle */
.prism-previewer-easing.prism-previewer-easing circle {
	fill: transparent;
}


@media (prefers-color-scheme: dark) {
    /**
     * One Dark theme for prism.js
     * Based on Atom's One Dark theme: https://github.com/atom/atom/tree/master/packages/one-dark-syntax
     */

    /**
     * One Dark colours (accurate as of commit 8ae45ca on 6 Sep 2018)
     * From colors.less
     * --mono-1: hsl(220, 14%, 71%);
     * --mono-2: hsl(220, 9%, 55%);
     * --mono-3: hsl(220, 10%, 40%);
     * --hue-1: hsl(187, 47%, 55%);
     * --hue-2: hsl(207, 82%, 66%);
     * --hue-3: hsl(286, 60%, 67%);
     * --hue-4: hsl(95, 38%, 62%);
     * --hue-5: hsl(355, 65%, 65%);
     * --hue-5-2: hsl(5, 48%, 51%);
     * --hue-6: hsl(29, 54%, 61%);
     * --hue-6-2: hsl(39, 67%, 69%);
     * --syntax-fg: hsl(220, 14%, 71%);
     * --syntax-bg: hsl(220, 13%, 18%);
     * --syntax-gutter: hsl(220, 14%, 45%);
     * --syntax-guide: hsla(220, 14%, 71%, 0.15);
     * --syntax-accent: hsl(220, 100%, 66%);
     * From syntax-variables.less
     * --syntax-selection-color: hsl(220, 13%, 28%);
     * --syntax-gutter-background-color-selected: hsl(220, 13%, 26%);
     * --syntax-cursor-line: hsla(220, 100%, 80%, 0.04);
     */

    code[class*="language-"],
    pre[class*="language-"] {
        background: hsl(220, 13%, 18%);
        color: hsl(220, 14%, 71%);
        text-shadow: 0 1px rgba(0, 0, 0, 0.3);
        font-family: "Fira Code", "Fira Mono", Menlo, Consolas, "DejaVu Sans Mono", monospace;
        direction: ltr;
        text-align: left;
        white-space: pre;
        word-spacing: normal;
        word-break: normal;
        line-height: 1.5;
        -moz-tab-size: 2;
        -o-tab-size: 2;
        tab-size: 2;
        -webkit-hyphens: none;
        -moz-hyphens: none;
        -ms-hyphens: none;
        hyphens: none;
    }

    /* Selection */
    code[class*="language-"]::-moz-selection,
    code[class*="language-"] *::-moz-selection,
    pre[class*="language-"] *::-moz-selection {
        background: hsl(220, 13%, 28%);
        color: inherit;
        text-shadow: none;
    }

    code[class*="language-"]::selection,
    code[class*="language-"] *::selection,
    pre[class*="language-"] *::selection {
        background: hsl(220, 13%, 28%);
        color: inherit;
        text-shadow: none;
    }

    /* Code blocks */
    pre[class*="language-"] {
        padding: 1em;
        margin: 0.5em 0;
        overflow: auto;
        border-radius: 0.3em;
    }

    /* Inline code */
    :not(pre) > code[class*="language-"] {
        padding: 0.2em 0.3em;
        border-radius: 0.3em;
        white-space: normal;
    }

    /* Print */
    @media print {
        code[class*="language-"],
        pre[class*="language-"] {
            text-shadow: none;
        }
    }

    .token.comment,
    .token.prolog,
    .token.cdata {
        color: hsl(220, 10%, 40%);
    }

    .token.doctype,
    .token.punctuation,
    .token.entity {
        color: hsl(220, 14%, 71%);
    }

    .token.attr-name,
    .token.class-name,
    .token.boolean,
    .token.constant,
    .token.number,
    .token.atrule {
        color: hsl(29, 54%, 61%);
    }

    .token.keyword {
        color: hsl(286, 60%, 67%);
    }

    .token.property,
    .token.tag,
    .token.symbol,
    .token.deleted,
    .token.important {
        color: hsl(355, 65%, 65%);
    }

    .token.selector,
    .token.string,
    .token.char,
    .token.builtin,
    .token.inserted,
    .token.regex,
    .token.attr-value,
    .token.attr-value > .token.punctuation {
        color: hsl(95, 38%, 62%);
    }

    .token.variable,
    .token.operator,
    .token.function {
        color: hsl(207, 82%, 66%);
    }

    .token.url {
        color: hsl(187, 47%, 55%);
    }

    /* HTML overrides */
    .token.attr-value > .token.punctuation.attr-equals,
    .token.special-attr > .token.attr-value > .token.value.css {
        color: hsl(220, 14%, 71%);
    }

    /* CSS overrides */
    .language-css .token.selector {
        color: hsl(355, 65%, 65%);
    }

    .language-css .token.property {
        color: hsl(220, 14%, 71%);
    }

    .language-css .token.function,
    .language-css .token.url > .token.function {
        color: hsl(187, 47%, 55%);
    }

    .language-css .token.url > .token.string.url {
        color: hsl(95, 38%, 62%);
    }

    .language-css .token.important,
    .language-css .token.atrule .token.rule {
        color: hsl(286, 60%, 67%);
    }

    /* JS overrides */
    .language-javascript .token.operator {
        color: hsl(286, 60%, 67%);
    }

    .language-javascript .token.template-string > .token.interpolation > .token.interpolation-punctuation.punctuation {
        color: hsl(5, 48%, 51%);
    }

    /* JSON overrides */
    .language-json .token.operator {
        color: hsl(220, 14%, 71%);
    }

    .language-json .token.null.keyword {
        color: hsl(29, 54%, 61%);
    }

    /* MD overrides */
    .language-markdown .token.url,
    .language-markdown .token.url > .token.operator,
    .language-markdown .token.url-reference.url > .token.string {
        color: hsl(220, 14%, 71%);
    }

    .language-markdown .token.url > .token.content {
        color: hsl(207, 82%, 66%);
    }

    .language-markdown .token.url > .token.url,
    .language-markdown .token.url-reference.url {
        color: hsl(187, 47%, 55%);
    }

    .language-markdown .token.blockquote.punctuation,
    .language-markdown .token.hr.punctuation {
        color: hsl(220, 10%, 40%);
        font-style: italic;
    }

    .language-markdown .token.code-snippet {
        color: hsl(95, 38%, 62%);
    }

    .language-markdown .token.bold .token.content {
        color: hsl(29, 54%, 61%);
    }

    .language-markdown .token.italic .token.content {
        color: hsl(286, 60%, 67%);
    }

    .language-markdown .token.strike .token.content,
    .language-markdown .token.strike .token.punctuation,
    .language-markdown .token.list.punctuation,
    .language-markdown .token.title.important > .token.punctuation {
        color: hsl(355, 65%, 65%);
    }

    /* General */
    .token.bold {
        font-weight: bold;
    }

    .token.comment,
    .token.italic {
        font-style: italic;
    }

    .token.entity {
        cursor: help;
    }

    .token.namespace {
        opacity: 0.8;
    }

    /* Plugin overrides */
    /* Selectors should have higher specificity than those in the plugins' default stylesheets */

    /* Show Invisibles plugin overrides */
    .token.token.tab:not(:empty):before,
    .token.token.cr:before,
    .token.token.lf:before,
    .token.token.space:before {
        color: hsla(220, 14%, 71%, 0.15);
        text-shadow: none;
    }

    /* Toolbar plugin overrides */
    /* Space out all buttons and move them away from the right edge of the code block */
    div.code-toolbar > .toolbar.toolbar > .toolbar-item {
        margin-right: 0.4em;
    }

    /* Styling the buttons */
    div.code-toolbar > .toolbar.toolbar > .toolbar-item > button,
    div.code-toolbar > .toolbar.toolbar > .toolbar-item > a,
    div.code-toolbar > .toolbar.toolbar > .toolbar-item > span {
        background: hsl(220, 13%, 26%);
        color: hsl(220, 9%, 55%);
        padding: 0.1em 0.4em;
        border-radius: 0.3em;
    }

    div.code-toolbar > .toolbar.toolbar > .toolbar-item > button:hover,
    div.code-toolbar > .toolbar.toolbar > .toolbar-item > button:focus,
    div.code-toolbar > .toolbar.toolbar > .toolbar-item > a:hover,
    div.code-toolbar > .toolbar.toolbar > .toolbar-item > a:focus,
    div.code-toolbar > .toolbar.toolbar > .toolbar-item > span:hover,
    div.code-toolbar > .toolbar.toolbar > .toolbar-item > span:focus {
        background: hsl(220, 13%, 28%);
        color: hsl(220, 14%, 71%);
    }

    /* Line Highlight plugin overrides */
    /* The highlighted line itself */
    .line-highlight.line-highlight {
        background: hsla(220, 100%, 80%, 0.04);
    }

    /* Default line numbers in Line Highlight plugin */
    .line-highlight.line-highlight:before,
    .line-highlight.line-highlight[data-end]:after {
        background: hsl(220, 13%, 26%);
        color: hsl(220, 14%, 71%);
        padding: 0.1em 0.6em;
        border-radius: 0.3em;
        box-shadow: 0 2px 0 0 rgba(0, 0, 0, 0.2); /* same as Toolbar plugin default */
    }

    /* Hovering over a linkable line number (in the gutter area) */
    /* Requires Line Numbers plugin as well */
    pre[id].linkable-line-numbers.linkable-line-numbers span.line-numbers-rows > span:hover:before {
        background-color: hsla(220, 100%, 80%, 0.04);
    }

    /* Line Numbers and Command Line plugins overrides */
    /* Line separating gutter from coding area */
    .line-numbers.line-numbers .line-numbers-rows,
    .command-line .command-line-prompt {
        border-right-color: hsla(220, 14%, 71%, 0.15);
    }

    /* Stuff in the gutter */
    .line-numbers .line-numbers-rows > span:before,
    .command-line .command-line-prompt > span:before {
        color: hsl(220, 14%, 45%);
    }

    /* Match Braces plugin overrides */
    /* Note: Outline colour is inherited from the braces */
    .rainbow-braces .token.token.punctuation.brace-level-1,
    .rainbow-braces .token.token.punctuation.brace-level-5,
    .rainbow-braces .token.token.punctuation.brace-level-9 {
        color: hsl(355, 65%, 65%);
    }

    .rainbow-braces .token.token.punctuation.brace-level-2,
    .rainbow-braces .token.token.punctuation.brace-level-6,
    .rainbow-braces .token.token.punctuation.brace-level-10 {
        color: hsl(95, 38%, 62%);
    }

    .rainbow-braces .token.token.punctuation.brace-level-3,
    .rainbow-braces .token.token.punctuation.brace-level-7,
    .rainbow-braces .token.token.punctuation.brace-level-11 {
        color: hsl(207, 82%, 66%);
    }

    .rainbow-braces .token.token.punctuation.brace-level-4,
    .rainbow-braces .token.token.punctuation.brace-level-8,
    .rainbow-braces .token.token.punctuation.brace-level-12 {
        color: hsl(286, 60%, 67%);
    }

    /* Diff Highlight plugin overrides */
    /* Taken from https://github.com/atom/github/blob/master/styles/variables.less */
    pre.diff-highlight > code .token.token.deleted:not(.prefix),
    pre > code.diff-highlight .token.token.deleted:not(.prefix) {
        background-color: hsla(353, 100%, 66%, 0.15);
    }

    pre.diff-highlight > code .token.token.deleted:not(.prefix)::-moz-selection,
    pre.diff-highlight > code .token.token.deleted:not(.prefix) *::-moz-selection,
    pre > code.diff-highlight .token.token.deleted:not(.prefix)::-moz-selection,
    pre > code.diff-highlight .token.token.deleted:not(.prefix) *::-moz-selection {
        background-color: hsla(353, 95%, 66%, 0.25);
    }

    pre.diff-highlight > code .token.token.deleted:not(.prefix)::selection,
    pre.diff-highlight > code .token.token.deleted:not(.prefix) *::selection,
    pre > code.diff-highlight .token.token.deleted:not(.prefix)::selection,
    pre > code.diff-highlight .token.token.deleted:not(.prefix) *::selection {
        background-color: hsla(353, 95%, 66%, 0.25);
    }

    pre.diff-highlight > code .token.token.inserted:not(.prefix),
    pre > code.diff-highlight .token.token.inserted:not(.prefix) {
        background-color: hsla(137, 100%, 55%, 0.15);
    }

    pre.diff-highlight > code .token.token.inserted:not(.prefix)::-moz-selection,
    pre.diff-highlight > code .token.token.inserted:not(.prefix) *::-moz-selection,
    pre > code.diff-highlight .token.token.inserted:not(.prefix)::-moz-selection,
    pre > code.diff-highlight .token.token.inserted:not(.prefix) *::-moz-selection {
        background-color: hsla(135, 73%, 55%, 0.25);
    }

    pre.diff-highlight > code .token.token.inserted:not(.prefix)::selection,
    pre.diff-highlight > code .token.token.inserted:not(.prefix) *::selection,
    pre > code.diff-highlight .token.token.inserted:not(.prefix)::selection,
    pre > code.diff-highlight .token.token.inserted:not(.prefix) *::selection {
        background-color: hsla(135, 73%, 55%, 0.25);
    }

    /* Previewers plugin overrides */
    /* Based on https://github.com/atom-community/atom-ide-datatip/blob/master/styles/atom-ide-datatips.less and https://github.com/atom/atom/blob/master/packages/one-dark-ui */
    /* Border around popup */
    .prism-previewer.prism-previewer:before,
    .prism-previewer-gradient.prism-previewer-gradient div {
        border-color: hsl(224, 13%, 17%);
    }

    /* Angle and time should remain as circles and are hence not included */
    .prism-previewer-color.prism-previewer-color:before,
    .prism-previewer-gradient.prism-previewer-gradient div,
    .prism-previewer-easing.prism-previewer-easing:before {
        border-radius: 0.3em;
    }

    /* Triangles pointing to the code */
    .prism-previewer.prism-previewer:after {
        border-top-color: hsl(224, 13%, 17%);
    }

    .prism-previewer-flipped.prism-previewer-flipped.after {
        border-bottom-color: hsl(224, 13%, 17%);
    }

    /* Background colour within the popup */
    .prism-previewer-angle.prism-previewer-angle:before,
    .prism-previewer-time.prism-previewer-time:before,
    .prism-previewer-easing.prism-previewer-easing {
        background: hsl(219, 13%, 22%);
    }

    /* For angle, this is the positive area (eg. 90deg will display one quadrant in this colour) */
    /* For time, this is the alternate colour */
    .prism-previewer-angle.prism-previewer-angle circle,
    .prism-previewer-time.prism-previewer-time circle {
        stroke: hsl(220, 14%, 71%);
        stroke-opacity: 1;
    }

    /* Stroke colours of the handle, direction point, and vector itself */
    .prism-previewer-easing.prism-previewer-easing circle,
    .prism-previewer-easing.prism-previewer-easing path,
    .prism-previewer-easing.prism-previewer-easing line {
        stroke: hsl(220, 14%, 71%);
    }

    /* Fill colour of the handle */
    .prism-previewer-easing.prism-previewer-easing circle {
        fill: transparent;
    }
}
* { box-sizing: border-box; }
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;

	--horizontal-padding: 3rem;
}
@media (max-width: 820px) {
	:root {
		--horizontal-padding: 1rem;
	}
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;
	--color-gray-95: #000308;

	--background-color: #FFFCF786;
	--background-color-solid: #FFFCF7;
	--background-image: url(/img/spiration-light.png);

	--theme-background-color: #00030813;

	--text-color: var(--color-gray-95);
	--text-color-link: #301014;
	--text-color-link-active: #5f2b48;
	--text-color-link-visited: #5E555A;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
    :root {
        --color-gray-20: #e0e0e0;
        --color-gray-50: #C0C0C0;
        --color-gray-90: #dad8d8;
        --color-gray-95: #FFFCF7;

        --theme-background-color: #FFFCF713;

        /* --text-color is assigned to --color-gray-_ above */
        --text-color-link: #b5bad0;
        --text-color-link-active: #FFDD93;
        --text-color-link-visited: #8594ad;

        --background-color: #06010a86;
        --background-color-solid: #06010a;
        --background-image: url(/img/spiration-dark.png);
    }
}

/* Global stylesheet */
* {
	box-sizing: border-box;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	min-height: 100vh;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	background-image: var(--background-image);
    scroll-behavior: smooth;
}
body {
	max-width: calc(80ch + var(--horizontal-padding) * 2);
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

a > svg:hover {
	fill: var(--text-color-link-active);
}

main {
	padding: 1rem var(--horizontal-padding);
}
main :first-child {
	margin-top: 0;
}

h1 {
	margin-top: 0.25em;
}

header {
	display: flex;
	border-bottom: 1px dashed var(--color-gray-90);
}
header:after {
	content: "";
	display: table;
	clear: both;
}

span.spacer {
	flex-grow: 1;
}

.links-nextprev {
	list-style: none;
	border-top: 1px dashed var(--color-gray-90);
	margin: 0 calc(-1 * var(--horizontal-padding));
	padding: 0;
}
.links-nextprev li {
	margin: 1em 0;
	padding: 0 var(--horizontal-padding);
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
}
pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
}
code {
	word-break: break-all;
}

img {
	display: block;
	margin: 0 auto;
	max-width: 100%;
	height: auto;
}

/* Header */
header {
	display: flex;
	gap: 1em .5em;
	flex-wrap: wrap;
	align-items: center;
	padding: 1em var(--horizontal-padding);
}
a[href]:visited.home-link,
.nav-item a[href]:visited {
	color: var(--text-color-link);
}
a[href]:hover.home-link,
a[href]:active.home-link,
.nav-item a[href]:hover,
.nav-item a[href]:active {
	color: var(--text-color-link-active);
}
.home-link {
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
	margin-right: 2em;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
	margin-right: 1em;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}


/* Posts list */
.postlist {
	list-style: none;
	padding: 0;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	margin-bottom: 1em;
}
.postlist-date {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

#subscribe-link > svg {
	vertical-align: bottom;
	margin-bottom: 0.125em;
}

/* About */
#sidebar-icon-links {
	margin-top: 1em;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	text-transform: capitalize;
	font-style: italic;
}
.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

/* Direct Links / Markdown Headers */
h2 {
    position: sticky;
    top: 0;
	margin-top: 1.5em;
    padding: 0.33em 0;
}

h2.sticky {
    background-color: var(--background-color-solid);
    z-index: 999;
}

h2.sticky.passed {
    opacity: 0;
    z-index: 998;
}

.header-anchor {
	text-decoration: none;
	font-style: normal;
	font-size: 1em;
	margin-left: .1em;
}
a[href].header-anchor,
a[href].header-anchor:visited {
	color: transparent;
}
a[href].header-anchor:focus,
a[href].header-anchor:hover {
	text-decoration: underline;
}
a[href].header-anchor:focus,
:hover > a[href].header-anchor {
	color: var(--text-color-link-active);
}

h2 + .header-anchor {
	font-size: 1.5em;
}</style>
		<!-- Google tag (gtag.js) -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-998XX4MGQY"></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());

			gtag('config', 'G-998XX4MGQY');
		</script>

	</head>
	<body>
		<a href="#skip" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">Brendan Innis</a>
			<nav>
				<h2 class="visually-hidden">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Posts</a></li>
					<li class="nav-item"><a href="/tags.html">Tags</a></li>
					<li class="nav-item"><a href="/about.html">About Me</a></li>
				</ul>
			</nav>
			<span class="spacer"></span>
		</header>

		<main id="skip">
			

<ul class="post-metadata">
	<li><svg width="24" height="24" viewBox="0 0 24 24" fill="var(--text-color)" xmlns="http://www.w3.org/2000/svg"><path d="M9 2a1 1 0 0 1 1 1v1h4V3a1 1 0 1 1 2 0v1h3a2 2 0 0 1 2 2v13a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h3V3a1 1 0 0 1 1-1zM8 6H5v3h14V6h-3v1a1 1 0 1 1-2 0V6h-4v1a1 1 0 0 1-2 0V6zm11 5H5v8h14v-8z"/></svg></li>
	<li><time datetime="2020-01-11">11 January 2020</time></li>
	<li><svg width="24" height="24" viewBox="0 0 24 24" fill="var(--text-color)" xmlns="http://www.w3.org/2000/svg"><path d="M2 3a1 1 0 0 1 1-1h8a1 1 0 0 1 .707.293l10 10a1 1 0 0 1 0 1.414l-8 8a1 1 0 0 1-1.414 0l-10-10A1 1 0 0 1 2 11V3zm2 1v6.586l9 9L19.586 13l-9-9H4z" /><path d="M9 7.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z" /></svg></li>
	<li><a href="/tags/android/" class="post-tag">Android</a>, </li>
	<li><a href="/tags/kotlin/" class="post-tag">Kotlin</a>, </li>
	<li><a href="/tags/networking/" class="post-tag">Networking</a></li>
</ul>

<h1>Connect Nearby Devices Part 2: Local Networking Android</h1>

<p>This post will show you how to create an Android app that can run on multiple nearby devices and connect them via a local network. This is part 2 of a larger tutorial that will explain how you can connect an app to other instances of the same app running on multiple devices and platforms.</p>
<p>In <a href="connect-nearby-devices-part-1.html">part 1</a> of this tutorial we built an iOS app that can connect to other instances of the same app. In this part we will build an Android app that can connect and share data between other instances of the same Android app, and the iOS app from part 1.</p>
<h2 id="example-local-networking-app" tabindex="-1">Example Local Networking App <a class="header-anchor" href="#example-local-networking-app">#</a></h2>
<p>I built and Android app that can join a realtime messaging chat with any other devices on the same local network. This is a port of the iOS app that was linked in part 1. These two apps can connect on the same network and join the same chat cross-platform on Android and iOS. The finished app is available here: <a href="https://github.com/brendaninnis/LocalNetworkingAndroidApp">Finished Example</a>.</p>
<h2 id="connecting-devices-over-a-local-network" tabindex="-1">Connecting devices over a local network <a class="header-anchor" href="#connecting-devices-over-a-local-network">#</a></h2>
<p>There are 2 parts to building this app, discovery and connection.</p>
<p>Discovery means we need devices running the same app to be able to see each other so that they can connect. For discovery we will use the native Android <a href="https://developer.android.com/training/connect-devices-wirelessly/nsd">Network Service Discovery</a> classes. This is equivalent and compatible with Bonjour on Apple devices and will allow us to publish and listen for services running on the same network. We can then get the ip address and port of the host device in order that we can connect.</p>
<p>For connection we will use TCP/IP sockets to connect our devices and pass messages back and forth. The classes from the native <a href="https://docs.oracle.com/javase/7/docs/api/java/net/package-summary.html">java.net</a> package will provide the sockets that we need.</p>
<h2 id="hosting" tabindex="-1">Hosting <a class="header-anchor" href="#hosting">#</a></h2>
<p>In order to maintain communication and a shared state between more than 2 devices, we will use a client-server model for this app. One device will act as a host, and every other device will act as a client of that host. Thus there will be a socket connection between each client and the host. The host must accept socket connections over the network.</p>
<p>First, we'll create a variable as a field of our Activity to hold our server socket.</p>
<pre class="language-kotlin" tabindex="0"><code class="language-kotlin"><span class="token keyword">var</span> serverSocket<span class="token operator">:</span> ServerSocket<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span></code></pre>
<p>Then, when we want to start hosting, we'll initialize a server socket. Passing <code>0</code> as the port argument allows the system to provide us a port. We'll get and store this port number for use later.</p>
<pre class="language-kotlin" tabindex="0"><code class="language-kotlin"><span class="token comment">// Create a listen socket</span>
<span class="token keyword">val</span> port<span class="token operator">:</span> Int
serverSocket <span class="token operator">=</span> <span class="token function">ServerSocket</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{</span> socket <span class="token operator">-></span>
    <span class="token comment">// Store the chosen port.</span>
    port <span class="token operator">=</span> socket<span class="token punctuation">.</span>localPort
<span class="token punctuation">}</span></code></pre>
<p>The <code>accept</code> method of <code>ServerSocket</code> is a long running, blocking method that listens for a connection to be made. We will call the method in a while loop so that when a connection is made, we can hold on to the new client socket, and then the loop will call <code>accept</code> again and wait for the next client.</p>
<p>Since we are calling a blocking method in an indeterminate while loop, we will need to run this code in it's own thread so we do not block the execution of our app.</p>
<pre class="language-kotlin" tabindex="0"><code class="language-kotlin"><span class="token function">Thread</span><span class="token punctuation">(</span>Runnable <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>serverSocket <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            serverSocket<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"ServerSocket"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"accepted client"</span></span><span class="token punctuation">)</span>

                <span class="token comment">// Hold on to the client socket</span>
                connectedClients<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> SocketException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>Now we have a thread that will execute our while loop until we decide to close our socket and set the value back to <code>null</code>. The server socket will wait to accept a connection from a client, and when it does, it will hold on to the client socket and the loop will run again and wait to accept the next client.</p>
<p>To get rid of the compiler error from the code above, we will add a variable as a field of our Activity that will hold onto the client sockets.</p>
<pre class="language-kotlin" tabindex="0"><code class="language-kotlin"><span class="token keyword">var</span> connectedClients<span class="token operator">:</span> MutableList<span class="token operator">&lt;</span>Socket<span class="token operator">></span> <span class="token operator">=</span> CopyOnWriteArrayList<span class="token operator">&lt;</span>Socket<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>We are using <code>CopyOnWriteArrayList</code> to ensure the thread safety of mutations on our list of clients. This class is inefficient if we are planning to mutate it a lot and if the list size will be very large, but for our purposes it will work very well and ensure thread safety with very little work on our part.</p>
<p>Now we have a server socket that is accepting connections and keeping track of it's clients. In order for our clients to discover the server and connect, they need to know the ip address and port number of the host device. We can publish and discover our service over the network using <a href="https://developer.android.com/training/connect-devices-wirelessly/nsd">NSD</a>.</p>
<h2 id="using-android-network-service-discovery" tabindex="-1">Using Android Network Service Discovery <a class="header-anchor" href="#using-android-network-service-discovery">#</a></h2>
<p>As the host device, we will be publishing a service over the network that client devices will be able to discover.
First we need an instance of <code>NsdManager</code> which we will lazy load as a field on our activity.</p>
<pre class="language-kotlin" tabindex="0"><code class="language-kotlin"><span class="token keyword">val</span> nsdManager<span class="token operator">:</span> NsdManager <span class="token keyword">by</span> lazy <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>NSD_SERVICE<span class="token punctuation">)</span> <span class="token keyword">as</span> NsdManager<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>Next we will need an instance of <code>NsdManager.RegistrationListener</code> to listen for callbacks. You will want to add code to the functions you will override in order to respond to errors and other important events.</p>
<pre class="language-kotlin" tabindex="0"><code class="language-kotlin"><span class="token keyword">private</span> <span class="token keyword">val</span> registrationListener <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">:</span> NsdManager<span class="token punctuation">.</span><span class="token function">RegistrationListener</span> <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onServiceRegistered</span><span class="token punctuation">(</span>NsdServiceInfo<span class="token operator">:</span> NsdServiceInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Save the service name. Android may have changed it in order to</span>
        <span class="token comment">// resolve a conflict, so update the name you initially requested</span>
        <span class="token comment">// with the name Android actually used.</span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"NsdManager.Registration"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Service registered"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onRegistrationFailed</span><span class="token punctuation">(</span>serviceInfo<span class="token operator">:</span> NsdServiceInfo<span class="token punctuation">,</span> errorCode<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Registration failed! Put debugging code here to determine why.</span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"NsdManager.Registration"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Registration failed"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onServiceUnregistered</span><span class="token punctuation">(</span>arg0<span class="token operator">:</span> NsdServiceInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Service has been unregistered. This only happens when you call</span>
        <span class="token comment">// NsdManager.unregisterService() and pass in this listener.</span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"NsdManager.Registration"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Service unregistered"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onUnregistrationFailed</span><span class="token punctuation">(</span>serviceInfo<span class="token operator">:</span> NsdServiceInfo<span class="token punctuation">,</span> errorCode<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Unregistration failed. Put debugging code here to determine why.</span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"NsdManager.Registration"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Unregistration failed"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Once we have created a server socket and are accepting connections, we'll publish our service.</p>
<pre class="language-kotlin" tabindex="0"><code class="language-kotlin"><span class="token comment">// Create the NsdServiceInfo object, and populate it.</span>
<span class="token keyword">val</span> serviceInfo <span class="token operator">=</span> <span class="token function">NsdServiceInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{</span>
    <span class="token comment">// The name is subject to change based on conflicts</span>
    <span class="token comment">// with other services advertised on the same network.</span>
    serviceName <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"LocalNetworkingApp"</span></span>
    serviceType <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"_LocalNetworkingApp._tcp."</span></span>
    <span class="token function">setPort</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Register the service for discovery</span>
nsdManager<span class="token punctuation">.</span><span class="token function">registerService</span><span class="token punctuation">(</span>serviceInfo<span class="token punctuation">,</span> NsdManager<span class="token punctuation">.</span>PROTOCOL_DNS_SD<span class="token punctuation">,</span> registrationListener<span class="token punctuation">)</span></code></pre>
<p>The name and type of our service will be <code>LocalNetworkingApp</code> and we will specify TCP as the protocol (this could be a value such as <code>&quot;_http._tcp&quot;</code>, for example, to specify an HTTP service). This will indicate that our service is for our local networking app and that the TCP protocol will be used.</p>
<p>Our service is now being broadcast over the local network so clients will be able to discover it and get the ip address and port number to connect to.</p>
<h2 id="clients" tabindex="-1">Clients <a class="header-anchor" href="#clients">#</a></h2>
<p>Once one device running our app is acting as the host, the rest of the devices will act as clients. The first thing to do is to discover the service so we can connect to the address of the host. We will use an instance of <code>NsdManager</code> to discover our service.</p>
<pre class="language-kotlin" tabindex="0"><code class="language-kotlin">nsdManager<span class="token punctuation">.</span><span class="token function">discoverServices</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"_LocalNetworkingApp._tcp."</span></span><span class="token punctuation">,</span> NsdManager<span class="token punctuation">.</span>PROTOCOL_DNS_SD<span class="token punctuation">,</span> discoveryListener<span class="token punctuation">)</span></code></pre>
<p>We are looking for services of our type. The <code>discoveryListener</code> will be a field on our activity that is an instance of <code>NsdManager.DiscoveryListener</code>.</p>
<pre class="language-kotlin" tabindex="0"><code class="language-kotlin"><span class="token keyword">private</span> <span class="token keyword">val</span> discoveryListener <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">:</span> NsdManager<span class="token punctuation">.</span><span class="token function">DiscoveryListener</span> <span class="token punctuation">{</span>

    <span class="token keyword">val</span> TAG <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"discoveryListener"</span></span>

    <span class="token comment">// Called as soon as service discovery begins.</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onDiscoveryStarted</span><span class="token punctuation">(</span>regType<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Service discovery started"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onServiceFound</span><span class="token punctuation">(</span>service<span class="token operator">:</span> NsdServiceInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Service found </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">service<span class="token punctuation">.</span>serviceName</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        nsdManager<span class="token punctuation">.</span><span class="token function">resolveService</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> resolveListener<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onServiceLost</span><span class="token punctuation">(</span>service<span class="token operator">:</span> NsdServiceInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// When the network service is no longer available.</span>
        <span class="token comment">// Internal bookkeeping code goes here.</span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"service lost: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">service</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onDiscoveryStopped</span><span class="token punctuation">(</span>serviceType<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Discovery stopped: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">serviceType</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onStartDiscoveryFailed</span><span class="token punctuation">(</span>serviceType<span class="token operator">:</span> String<span class="token punctuation">,</span> errorCode<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Discovery failed: Error code:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">errorCode</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        nsdManager<span class="token punctuation">.</span><span class="token function">stopServiceDiscovery</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onStopDiscoveryFailed</span><span class="token punctuation">(</span>serviceType<span class="token operator">:</span> String<span class="token punctuation">,</span> errorCode<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Discovery failed: Error code:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">errorCode</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        nsdManager<span class="token punctuation">.</span><span class="token function">stopServiceDiscovery</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>The important method above is <code>onServiceFound</code>. Once we have discovered our service, we need to resolve it using an instance of <code>NsdManager.ResolveListener</code>. Create another field on your activity called <code>resolveListener</code> and one called <code>socket</code> to hold the socket that will connect to the host.</p>
<pre class="language-kotlin" tabindex="0"><code class="language-kotlin"><span class="token keyword">var</span> socket<span class="token operator">:</span> Socket<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token keyword">private</span> <span class="token keyword">val</span> resolveListener <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">:</span> NsdManager<span class="token punctuation">.</span><span class="token function">ResolveListener</span> <span class="token punctuation">{</span>

    <span class="token keyword">val</span> TAG <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"resolveListener"</span></span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onResolveFailed</span><span class="token punctuation">(</span>serviceInfo<span class="token operator">:</span> NsdServiceInfo<span class="token punctuation">,</span> errorCode<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Called when the resolve fails. Use the error code to debug.</span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Resolve failed: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">errorCode</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onServiceResolved</span><span class="token punctuation">(</span>serviceInfo<span class="token operator">:</span> NsdServiceInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Resolve Succeeded. </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">serviceInfo</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        socket<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Socket already connected </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">it</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// Connect to the host</span>
            socket <span class="token operator">=</span> <span class="token function">Socket</span><span class="token punctuation">(</span>serviceInfo<span class="token punctuation">.</span>host<span class="token punctuation">,</span> serviceInfo<span class="token punctuation">.</span>port<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> UnknownHostException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Unknown host. </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">e<span class="token punctuation">.</span>localizedMessage</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Assuming no exception was thrown we now have a socket connected to a host device.</p>
<p>That's it! Now our app has the ability to connect with other instances of itself running on the same network.</p>
<p>Of course the whole point on this is so that we can pass messages between them, so let's go over reading and writing to sockets.</p>
<h2 id="sending-messages" tabindex="-1">Sending Messages <a class="header-anchor" href="#sending-messages">#</a></h2>
<p>As long as our devices are connected, we will be constantly reading a stream of data coming over the network. In order to know when a message begins and ends we will use a terminator. To comply with our iOS app from the previous part of this tutorial, we will use <code>&quot;\r\n&quot;</code>. Add this to the top of your Kotlin Activity file, below the imports:</p>
<pre class="language-kotlin" tabindex="0"><code class="language-kotlin"><span class="token keyword">const</span> <span class="token keyword">val</span> MESSAGE_TERMINATOR <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"\r\n"</span></span></code></pre>
<p>First, let's create a class in our activity for the host device that will read messages from connected clients. Since we will be creating an indeterminate while loop, this class will be a subclass of <code>Runnable</code> so we can pass it as an argument to a new thread.</p>
<pre class="language-kotlin" tabindex="0"><code class="language-kotlin"><span class="token keyword">inner</span> <span class="token keyword">class</span> <span class="token function">ClientReader</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> client<span class="token operator">:</span> Socket<span class="token punctuation">)</span><span class="token operator">:</span> Runnable <span class="token punctuation">{</span>
    <span class="token keyword">val</span> TAG <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"ClientReader"</span></span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> line<span class="token operator">:</span> String<span class="token operator">?</span>
        <span class="token keyword">val</span> reader<span class="token operator">:</span> BufferedReader

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            reader <span class="token operator">=</span> <span class="token function">BufferedReader</span><span class="token punctuation">(</span><span class="token function">InputStreamReader</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"BufferedReader failed to initialize"</span></span><span class="token punctuation">)</span>

            connectedClients<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                line <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>line <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    connectedClients<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
                    <span class="token keyword">break</span>
                <span class="token punctuation">}</span>

                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Read line </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">line</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                connectedClients<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Each iteration of the while loop will call the <code>readLine</code> method of <code>BufferedReader</code>, which will read until our terminator. If the connection is terminated we will remove the client and break the while loop in order to end the execution of our <code>Runnable</code>.</p>
<p>When a host accepts a new client, we will start reading from the socket immediately. Modify your code where you are accepting clients on the <code>ServerSocket</code> so it looks like this:</p>
<pre class="language-kotlin" tabindex="0"><code class="language-kotlin"><span class="token function">Thread</span><span class="token punctuation">(</span>Runnable <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>serverSocket <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            serverSocket<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"ServerSocket"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"accepted client"</span></span><span class="token punctuation">)</span>

                <span class="token comment">// Hold on to the client socket</span>
                connectedClients<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>

                <span class="token comment">// Start reading messages</span>
                <span class="token function">Thread</span><span class="token punctuation">(</span><span class="token function">ClientReader</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> SocketException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>Now when our host accepts a new connection, we will start reading reading from the client socket on a new thread, which will continue until the client disconnects.</p>
<p>We'll create a similar reader class for our clients to use.</p>
<pre class="language-kotlin" tabindex="0"><code class="language-kotlin"><span class="token keyword">inner</span> <span class="token keyword">class</span> <span class="token function">ServerReader</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> socket<span class="token operator">:</span> Socket<span class="token punctuation">)</span><span class="token operator">:</span> Runnable <span class="token punctuation">{</span>
    <span class="token keyword">val</span> TAG <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"ServerReader"</span></span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> line<span class="token operator">:</span> String<span class="token operator">?</span>
        <span class="token keyword">val</span> reader<span class="token operator">:</span> BufferedReader

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            reader <span class="token operator">=</span> <span class="token function">BufferedReader</span><span class="token punctuation">(</span><span class="token function">InputStreamReader</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"BufferedReader failed to initialize"</span></span><span class="token punctuation">)</span>

            socket <span class="token operator">=</span> <span class="token keyword">null</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                line <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>line <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    socket <span class="token operator">=</span> <span class="token keyword">null</span>
                    <span class="token keyword">break</span>
                <span class="token punctuation">}</span>

                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Read line </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">line</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                socket <span class="token operator">=</span> <span class="token keyword">null</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>The difference here is that when the server disconnects we will set our socket to <code>null</code> rather than removing a client like we did for the server.</p>
<p>When we want to send a message through the socket, wether it is from the client to the server or from the server to the client, we will use a subclass of <code>Writer</code> initialized with the output stream of the socket.</p>
<pre class="language-kotlin" tabindex="0"><code class="language-kotlin"><span class="token keyword">val</span> writer<span class="token operator">:</span> PrintWriter

<span class="token keyword">try</span> <span class="token punctuation">{</span>
    writer <span class="token operator">=</span> <span class="token function">PrintWriter</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// If the writer fails to initialize there was an io problem, close your connection</span>
<span class="token punctuation">}</span></code></pre>
<p>Then when you are ready to write a message call <code>print</code> and <code>flush</code>.</p>
<pre class="language-kotlin" tabindex="0"><code class="language-kotlin">writer<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Hello from the network!"</span></span> <span class="token operator">+</span> MESSAGE_TERMINATOR<span class="token punctuation">)</span>
writer<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>Make sure to append the terminator to your message, so you know when to stop reading.</p>
<p>When you are done sending messages and ready to disconnect and close the socket, make sure you close your writer.</p>
<pre class="language-kotlin" tabindex="0"><code class="language-kotlin">writer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>When we want to end the connection from the host or stop hosting we should do some cleanup.</p>
<pre class="language-kotlin" tabindex="0"><code class="language-kotlin"><span class="token keyword">if</span> <span class="token punctuation">(</span>host<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Stop listening</span>
    serverSocket<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    serverSocket <span class="token operator">=</span> <span class="token keyword">null</span>

    <span class="token comment">// Stop broadcasting service</span>
    nsdManager<span class="token punctuation">.</span><span class="token function">unregisterService</span><span class="token punctuation">(</span>registrationListener<span class="token punctuation">)</span>

    <span class="token comment">// Remove the clients</span>
    connectedClients<span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span>
        it<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        nsdManager<span class="token punctuation">.</span><span class="token function">stopServiceDiscovery</span><span class="token punctuation">(</span>discoveryListener<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IllegalArgumentException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"nsdManager"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"discoveryListener not registered"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    socket<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    socket <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="done" tabindex="-1">Done <a class="header-anchor" href="#done">#</a></h2>
<p>This should be all you need to get started connecting multiple devices running the same app over the local network and sending messages back and forth. For a complete example of an app doing this, you can see my example <a href="https://github.com/brendaninnis/LocalNetworkingAndroidApp">messaging app</a>.</p>
<p>You can see part 1 of this tutorial series to build an iOS app that can connect to this one <a href="connect-nearby-devices-part-1.html">here</a>.</p>
<p>In future parts of this series I will explain how to accomplish the same thing using Bluetooth communication. If there's anything I didn't explain or anything else you want to know, I'd love it if you left a comment.</p>

<ul class="links-nextprev"><li>Previous: <a href="/connect-nearby-devices-part-1.html">Connect Nearby Devices Part 1: Local Networking iOS</a></li><li>Next: <a href="/functions-why-smaller-is-not-always-better.html">Functions: Why Smaller is Not Always Better</a></li>
</ul>

		</main>

		<footer></footer>

		<!-- This page `/connect-nearby-devices-part-2.html` was built on 2024-09-09T16:12:18.011Z -->

        <!-- Scroll to anchors -->
        <script defer>
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.location.hash = e.target.hash;
                    let header = e.target.parentElement
                    let offset = header.nextElementSibling.offsetTop - header.offsetHeight - 16; // 16px is the margin
                    window.scrollTo({
                        top: offset,
                        behavior: 'smooth'
                    });
                });
            });
        </script>

        <!-- Sticky Headers -->
        <script defer>
            let stickyHeaders = [];

            const observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    const header = entry.target;
                    if (entry.isIntersecting) {
                        stickyHeaders.forEach(header => {
                            header.classList.add('passed');
                        });
                        stickyHeaders.push(header);
                        header.classList.add('sticky');
                    } else {
                        header.classList.remove('sticky');
                        stickyHeaders.pop();
                        if (stickyHeaders.length > 0) {
                            stickyHeaders[stickyHeaders.length - 1].classList.remove('passed');
                        }
                    }
                });
            }, {
                rootMargin: '0px 0px -100% 0px',
                threshold: 0
            });

            const headers = document.querySelectorAll('h2:not(.visually-hidden)');
            headers.forEach(header => {
                observer.observe(header);
            });
        </script>

	</body>
</html>
